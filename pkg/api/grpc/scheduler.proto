syntax = "proto3";

package scheduler;

option go_package = "github.com/azizbahloul/gpu-scheduler/pkg/api/grpc/generated;scheduler";

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";

// Scheduler service for job management
service SchedulerService {
  rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);
  rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse);
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);
  rpc UpdateTenantQuota(UpdateTenantQuotaRequest) returns (UpdateTenantQuotaResponse);
  rpc GetMetrics(GetMetricsRequest) returns (GetMetricsResponse);
  rpc GetClusterStatus(GetClusterStatusRequest) returns (GetClusterStatusResponse);
}

message SubmitJobRequest {
  string tenant_id = 1;
  string name = 2;
  int32 priority = 3;
  int32 gpu_count = 4;
  int64 gpu_memory_mb = 5;
  int32 cpu_cores = 6;
  int64 memory_mb = 7;
  string script = 8;
  map<string, string> environment = 9;
  string image = 10;
  repeated string command = 11;
  repeated string args = 12;
  bool gang_scheduling = 13;
  google.protobuf.Duration max_runtime = 14;
  bool checkpoint_enabled = 15;
  map<string, string> labels = 16;
}

message SubmitJobResponse {
  string job_id = 1;
  string status = 2;
  string message = 3;
  int32 queue_position = 4;
  google.protobuf.Duration estimated_wait = 5;
}

message CancelJobRequest {
  string job_id = 1;
  string tenant_id = 2;
}

message CancelJobResponse {
  bool success = 1;
  string message = 2;
}

message GetJobStatusRequest {
  string job_id = 1;
  string tenant_id = 2;
}

message GetJobStatusResponse {
  string job_id = 1;
  string state = 2;
  string message = 3;
  repeated string allocated_gpus = 4;
  string node_name = 5;
  int32 queue_position = 6;
  google.protobuf.Duration estimated_wait = 7;
  google.protobuf.Timestamp submitted_at = 8;
  google.protobuf.Timestamp started_at = 9;
  google.protobuf.Timestamp completed_at = 10;
  map<string, double> metrics = 11;
}

message ListJobsRequest {
  string tenant_id = 1;
  string state = 2;
  int32 limit = 3;
  int32 offset = 4;
}

message ListJobsResponse {
  repeated JobInfo jobs = 1;
  int32 total = 2;
}

message JobInfo {
  string job_id = 1;
  string name = 2;
  string state = 3;
  int32 gpu_count = 4;
  google.protobuf.Timestamp submitted_at = 5;
  google.protobuf.Timestamp started_at = 6;
  int32 priority = 7;
}

message UpdateTenantQuotaRequest {
  string tenant_id = 1;
  int32 max_gpus = 2;
  int64 max_gpu_memory_mb = 3;
  int32 max_cpu_cores = 4;
  int64 max_memory_mb = 5;
  int32 max_concurrent_jobs = 6;
}

message UpdateTenantQuotaResponse {
  bool success = 1;
  string message = 2;
}

message GetMetricsRequest {
  string metric_type = 1;
  google.protobuf.Duration time_range = 2;
}

message GetMetricsResponse {
  map<string, double> metrics = 1;
  google.protobuf.Timestamp timestamp = 2;
}

message GetClusterStatusRequest {}

message GetClusterStatusResponse {
  int32 total_gpus = 1;
  int32 available_gpus = 2;
  int32 total_nodes = 3;
  int32 online_nodes = 4;
  int32 total_jobs = 5;
  int32 pending_jobs = 6;
  int32 running_jobs = 7;
  double avg_gpu_utilization = 8;
  repeated NodeStatus nodes = 9;
}

message NodeStatus {
  string node_id = 1;
  string name = 2;
  int32 total_gpus = 3;
  int32 available_gpus = 4;
  bool online = 5;
  double cpu_utilization = 6;
  double memory_utilization = 7;
}
